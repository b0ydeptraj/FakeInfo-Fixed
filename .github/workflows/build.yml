name: Build iOS Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Theos
      uses: Randomblock1/theos-action@v1
      
    - name: Build Package
      run: |
        export THEOS=$THEOS_INSTANCE
        echo "THEOS=$THEOS"
        ls -la $THEOS/
        make package FINALPACKAGE=1
        
    - name: List Output
      run: |
        echo "=== Packages ==="
        ls -la packages/ || echo "No packages"
        echo "=== Objects ===" 
        ls -la .theos/obj/ || echo "No obj"
        
    - name: Extract dylib from DEB
      run: |
        mkdir -p output
        if ls packages/*.deb 1> /dev/null 2>&1; then
          cd packages
          ar -x *.deb 2>/dev/null || true
          tar -xf data.tar.* 2>/dev/null || true
          find . -name "*.dylib" -exec cp {} ../output/ \;
          cd ..
        fi
        # Also check .theos folder
        find .theos -name "*.dylib" -exec cp {} output/ \; 2>/dev/null || true
        echo "=== Output ==="
        ls -la output/
        
    - name: Upload DEB
      uses: actions/upload-artifact@v4
      with:
        name: FakeInfo-deb
        path: packages/*.deb
        if-no-files-found: warn
        
    - name: Upload dylib
      uses: actions/upload-artifact@v4
      with:
        name: FakeInfo-dylib
        path: output/*.dylib
        if-no-files-found: warn
