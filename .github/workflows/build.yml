name: Build iOS Tweak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Theos
      uses: Randomblock1/theos-action@v1
      
    - name: Build Package
      run: |
        # theos-action sets THEOS in env automatically
        echo "THEOS path: $THEOS"
        ls -la $THEOS/ || echo "THEOS not found, trying default"
        
        # Fallback if THEOS not set
        if [ -z "$THEOS" ]; then
          export THEOS=$HOME/theos
        fi
        
        echo "Final THEOS: $THEOS"
        make package FINALPACKAGE=1
        
    - name: List Output
      if: always()
      run: |
        echo "=== Packages ==="
        ls -la packages/ || echo "No packages"
        echo "=== .theos ===" 
        ls -la .theos/ || echo "No .theos"
        find . -name "*.dylib" 2>/dev/null || echo "No dylib found"
        
    - name: Extract dylib from DEB
      if: always()
      run: |
        mkdir -p output
        if ls packages/*.deb 1> /dev/null 2>&1; then
          cd packages
          ar -x *.deb 2>/dev/null || true
          tar -xf data.tar.* 2>/dev/null || true
          find . -name "*.dylib" -exec cp {} ../output/ \;
          cd ..
        fi
        find .theos -name "*.dylib" -exec cp {} output/ \; 2>/dev/null || true
        echo "=== Output ==="
        ls -la output/ || echo "Empty output"
        
    - name: Upload DEB
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: SystemConfig-deb
        path: packages/*.deb
        if-no-files-found: warn
        
    - name: Upload dylib
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: SystemConfig-dylib
        path: output/*.dylib
        if-no-files-found: warn
